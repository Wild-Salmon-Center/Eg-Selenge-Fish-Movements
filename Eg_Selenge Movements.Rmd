---
title: "Eg_Selenge Fish Movements"
author: "J.Hart"
date: "2025-11-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Attach packages
library(tidyverse)
library(sf)
library(readxl)
library(riverdist)
library(janitor)
library(maptiles)
library(tidyterra)
```

```{r Read in data}
# Read in taimen movements & filter for > 1 acquisitions

taimen <- read_excel("Taimen_Movements_Eg_Selenge.xlsx") %>% 
  clean_names() %>% 
  group_by(fish_id) %>%
  filter(n() > 1) %>%
  ungroup()

```

```{r Read in data as spatial object and map}
# Convert to sf object and project to UTM
taimen_sf <- st_as_sf(taimen, coords = c("longitude", "latitude")) %>%
  st_set_crs(4326) %>% 
  st_transform(crs = 32648)

# Get basemap tiles for reference
tiles <- get_tiles(taimen_sf, provider = "OpenStreetMap", crop=TRUE)
plot_tiles(basemap_tiles)

# Plot locations
ggplot() +
  geom_spatraster_rgb(data = tiles) +
  geom_sf(data = taimen_sf, color = "blue") +
  labs(title = "Taimen Movement Locations - Eg/Selenge") +
  theme_minimal()


```

```{r Load river network}
# Load river network
MyRivernetwork <- line2network(path ="Spatial", layer ="FlowNetwork_Final")

# Confirm river network looks accurate
plot(MyRivernetwork)

# Show network segments
showends(seg=1, rivers=MyRivernetwork)
showends(seg=2, rivers=MyRivernetwork)

# Define start of river network
riv <- setmouth(seg=1,vert=22362,rivers=MyRivernetwork)
plot(riv)

# Run and perform topology checks on river network
network_clean <- cleanup(riv)

# Verify river network segmented correctly
topologydots(rivers=network_clean)


```

```{r Calculate distances}

## Euclidean Distances

# Find max euclidean distance
euc_distances <- taimen_sf %>%
  group_by(fish_id) %>% 
  summarize(
    max_dist_m = max(st_distance(geometry, geometry)))

#-----------------------------------------------

## River Distances

# Read in taimen location acquisitions
taimen_riv <- xy2segvert(x=taimen$latitude, y=taimen$longitude, rivers=network_clean)

# Snap point locations to cleaned river network
taimen_locs <- pointshp2segvert(path ="Spatial", layer ="Taimen", rivers=network_clean) %>% 
  filter(Code == "154")

# Array of acquisition IDs for distance matrix
taimen_locs.ID <- taimen_locs$Unique_ID

# Calculate distances between each location ping
distance_matrix <- riverdistancemat(seg = taimen_locs$seg, vert = taimen_locs$vert, ID=taimen_locs.ID, rivers = network_clean)
# Calculate max river distance
max_distance_km <- max(distance_matrix) / 1000


# View point locations on network
zoomtoseg(seg=1, rivers=network_clean)
points(taimen_locs$snap_x, taimen_locs$snap_y, pch=16, col="red")
riverpoints(seg=taimen_locs$seg, vert=taimen_locs$vert, rivers=network_clean, pch=15, col="blue")

```

```{r}
taimen_maxrivdist <- read_excel("Taimen_MaxDistances.xlsx") %>% 
  clean_names()

ggplot(taimen_maxrivdist, aes(x = reorder(as.factor(id),max_river_distance_km), y = max_river_distance_km, fill = crossed_dam_site)) +
  geom_col() +
  scale_fill_manual(values = c("deepskyblue3", "coral2")) +
  scale_y_continuous(expand = c(0,0), limits = c(0, 260)) +
  labs(title = "Taimen Tracking Maximum Displacement",
       subtitle = "Selenge/Eg Rivers",
       y = "River KM",
       x = "Taimen Tag ID",
       fill = "Crossed Proposed Egiin Gol Hydroelectric Site") +
  theme_bw() +
  theme(legend.position = "bottom",
        plot.subtitle = element_text(size = 14),
        plot.title = element_text(size= 16, face="bold"),
        axis.text=element_text(size= 10),
        axis.title=element_text(size= 12)) 
      

```

